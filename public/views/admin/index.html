<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Triplete | Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/bootstrap.css">
    <link rel="stylesheet" href="../../css/informacion.css">
    <style>

    </style>
        <script>
            window.addEventListener("DOMContentLoaded",()=>{
                console.log("bagre");
                if (!localStorage.getItem("session")){
                  location.href = '..'
                }
              }
            ) 
            </script>
</head>

<body>
    <nav-bar inref="../login" upref="../register" pref="../admin" iref="../repo" href="../" bref="../bet"></nav-bar>
    <div class="toast bg-dark text-white" role="alert"style="position: absolute; ;left: 70%;top:40%;z-index: 2;width: 40%;">
        <div class="toast-header" >
          <strong class="mr-auto">Notificacion</strong>
          <button class="ml-2 mb-2 close" data-dismiss="toast">x</button>
        </div>
        <div class="toast-body text-center">
        </div>
      </div>
    <div class="container bg-dark mt-5" style="border-radius: 10px">
        <nav class="mt-2">
            <div class="nav nav-tabs mt-2" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active mt-2" id="nav-team-tab" data-toggle="tab" href="#nav-team" role="tab" aria-controls="nav-team" aria-selected="true" style="color:white">Equipos</a>
                <a class="nav-item nav-link mt-2" id="nav-matches-tab" data-toggle="tab" href="#nav-matches" role="tab" aria-controls="nav-matches" aria-selected="false" style="color:white">Partidos</a>
                <a class="nav-item nav-link mt-2" id="nav-contact-tab" data-toggle="tab" href="#nav-contact" role="tab" aria-controls="nav-contact" aria-selected="false" style="color:white">Torneos</a>
            </div>
        </nav>

        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-team" role="tabpanel" aria-labelledby="nav-team-tab">

                <div class="row mb-2" id="searchRow">
                    <div class="input-group col-sm-8 mt-2">
                        <input type="text success" id="searchTeam" class="form-control" placeholder="Nombre de equipo" aria-label="Nombre de Equipo" aria-describedby="button-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-outline-success btn-add-panel" type="button" id="buttonTeam">Search</button>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <button class="btn btn-outline-danger mt-2" id="clearTeams">Limpiar resultados</button>
                        <button type="button" class="btn btn-outline-warning mt-2 text-center" data-toggle="modal" data-target="#addTeamM">Añadir equipo</button>

                        <div class="modal fade bd-example-modal-md" id="addTeamM" tabindex="-2" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content" style="background-color:#212529;color:white;">
                              <div class="modal-header">
                                <h5 class="modal-title h4 text-center" id="add">Añadir Equipo</h5>
                                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">×</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <div class="row">
                                        <div class="form mb-3" style="width: 80%;margin-left: 10%;">
                            <label class="text-left" for="name">Nombre del Equipo</label>
                            <input type="text" class="form-control" id="name_team" aria-describedby="nameHelp" placeholder="Ej: Barcelona">
                            <label class="text-left my-2" for="country">Pais</label>
                            <select class="custom-select " id="team_c" aria-label="Example select with button addon">
                              </select>
                             <label class="text-left my-2" for="descrip">Descripcion</label>
                            <input type="text" class="form-control" placeholder="Ej: Equipo de futbol" aria-label="descrip" id="descrip">
                            <label class="text-left my-2" for="tournent">Torneo en el que participa</label>
                            <select class="custom-select " id="team_t" aria-label="Example select with button addon">
                            </select>                        
                                      </div>
        
                                </div>
                                <br>
                                <br>
                                <div class="text-center">
                                        <button class="btn btn-outline-success mt-2 text-center" data-dismiss="modal" onclick="insertTeam()" >Añadir</button>
        
                                  </div>                        
                                </div>
                              </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="panel-group col" id="accordionTeam"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="nav-matches" role="tabpanel" aria-labelledby="nav-matches-tab">
                    <div class="row mb-2" id="searchRow">
                            <div class="input-group col-sm-8 mt-2">
                                            <div class="input-group mb-3">

                                                    <select class="custom-select " id="torneos" aria-label="Example select with button addon" onclick="changeSearch(this.value)">

                                                    </select>
                                                    <div class="input-group-prepend">
                                                            <button class="btn btn-outline-success btn-add-panel" type="button" id="button-addon2" onclick="searchMatches()" style="border-top-right-radius: 5px;border-bottom-right-radius: 5px">Search</button>
                                                        </div>
                                                  </div>
                                          
                            </div>
                            <div class="col-sm-4">
                                <button class="btn btn-outline-danger mt-2" id="clearMatch">Limpiar resultados</button>
                                <button type="button" class="btn btn-outline-warning mt-2 text-center" data-toggle="modal" data-target="#addMatchM">Añadir Partido</button>

                                <div class="modal fade bd-example-modal-md" id="addMatchM" tabindex="-2" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
                                  <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content" style="background-color:#212529;color:white;">
                                      <div class="modal-header">
                                        <h5 class="modal-title h4 text-center" id="add">Añadir Partido</h5>
                                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">×</span>
                                        </button>
                                      </div>
                                      <div class="modal-body">
                                        <div class="row">
                                                <div class="form mb-3" style="width: 80%;margin-left: 10%;">
                                    <label class="text-left" for="name">Local</label>
                                    <select class="custom-select " id="match_team1" aria-label="Example select with button addon">
                                      </select>
                                    <label class="text-left my-2" for="country">Visitante</label>
                                    <select class="custom-select " id="match_team2" aria-label="Example select with button addon">
                                      </select>
                                    <label class="text-left my-2" for="descrip">Fecha</label>
                                    <input type="date" class="form-control" placeholder="2019-4-29" aria-label="descrip" id="match_date">
                                    <label class="text-left my-2" for="tournent">Torneo en el que participa</label>
                                    <select class="custom-select " id="match_t" aria-label="Example select with button addon">
                                    </select>                        
                                              </div>
                
                                        </div>
                                        <br>
                                        <br>
                                        <div class="text-center">
                                                <button class="btn btn-outline-success mt-2 text-center" data-dismiss="modal" onclick="insertMatch()" >Añadir</button>
                
                                          </div>                        
                                        </div>
                                      </div>
                                    </div>
                                </div>                            
                              </div>
                        </div>
                <div class="list-group mt-2 pb-2" id="matchesList">
                </div>
             </div>
          <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">
            <div class="searchRow">
              <button type="button" class="btn btn-outline-warning mt-2 text-center" data-toggle="modal" data-target="#addTorM">Añadir Torneo</button>
            </div>

            <div class="modal fade bd-example-modal-md" id="addTorM" tabindex="-2" role="dialog" aria-labelledby="myExtraLargeModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="background-color:#212529;color:white;">
                  <div class="modal-header">
                    <h5 class="modal-title h4 text-center" id="add">Añadir Torneo</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">×</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                            <div class="form mb-3" style="width: 80%;margin-left: 10%;">
                <label class="text-left" for="name">Nombre del Torneo</label>
                <input type="text" class="form-control" id="name_tor" aria-describedby="nameHelp" placeholder="Ej: Copa del Rey">
                <label class="text-left my-2" for="country">Pais</label>
                <select class="custom-select " id="tor_c" aria-label="Example select with button addon">
                  </select>
                  <label class="text-left my-2" for="tournent">Tipo de torneo</label>
                <select class="custom-select " id="type_tor" aria-label="Example select with button addon">
                    <option value="1">Copa</option>

                </select>                        
                          </div>

                    </div>
                    <br>
                    <br>
                    <div class="text-center">
                            <button class="btn btn-outline-success mt-2 text-center" data-dismiss="modal" onclick="insertTor()" >Añadir</button>

                      </div>                        
                    </div>
                  </div>
                </div>
            </div>             <div class="list-group mt-2 pb-2" id="tourneyList"></div>
          </div>        
          </div>
    </div>
    <script type="text/javascript" src="../../components/navbar.js"></script>
    <script type="text/javascript" src="../../js/popper.js"></script>
    <script type="text/javascript" src="../../js/jquery.js"></script>
    <script type="text/javascript" src="../../js/bootstrap.js"></script>
    <script>
      var hash = 1;
      $('.toast').toast({delay:10000})

$("#clearMatches").on("click", ()=>{
  removeSearch("#matchesList")
})

let addTeam = (obj) =>{
  console.log(obj)
  $("#accordionTeam").append(
    '<div class="panel panel-default mb-1 ml-3 col" style="margin-right: 2%">'+
    '<div class="panel-heading" role="tab" id="heading_'+ ++hash +'">'+
      '<h4 class="panel-title">'+
        '<a role="button" data-toggle="collapse" data-parent="#accordionTeam" href="#collapse_'+ hash +'" aria-expanded="true" aria-controls="collapse_'+hash+'">'+
            obj.teams_name+
        '</a>'+
      '</h4>'+
    '</div>'+
    '<div id="collapse_'+hash+'" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_'+hash+'">'+
      '<div class="panel-body">'+
        '<div class="row mb-2">'+
          '<div class="col-sm-8 text-break bg-dark rounded" style="margin-left:10px">'+  
            "Descripcion: <br/> "+obj.team_description+
          "</div>"+
          '<div class="col-sm-3 bg-dark rounded" style="margin-left: 10px">'+  
            " Pais: <br/>" +obj.country_name+
            "<br/>"+
            "Promedio:</br>"+
            obj.teams_average+
          "</div>"+
          `<button class="btn btn-danger mt-2 ml-5" onclick="deleteTeam(${obj.teams_id})">Eliminar</button>
          <a href="../update?id=${obj.teams_id}" class="btn btn-warning mt-2 ml-5">Modificar</a>`+
        "</div>"+
      '</div>'+
    '</div>'+
  '</div>'
  )
}

let addMatch = (obj) => {
      $("#matchesList").append(
          `<a href="../updateMatch?id=${obj.match_id}" class="btn list-group-item list-group-item-action text-center d-inline w-90" '>${obj.teams.local.name} vs ${obj.teams.visitante.name} 
          </br>Fecha:${obj.match_date}</a>
	<a class="mb-2 btn btn-danger d-inline" onclick="deleteMatch(${obj.match_id})">Eliminar Partido</a>`
      )
  }


let deleteTourney = (id) =>{
  data ={
    tournament_id:id
  }
  let url = "../../Tournaments/"
  fetch(url,{
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
    body:JSON.stringify(data)

  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 200){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      console.log("status"+response.status+", msg:"+response.message)
    }

  })
  .catch(error=>{
    console.log(error)
  })  
}

let deleteMatch = (id) =>{
  data ={
    matchId:id
  }
  let url = "../../Match/" 
  fetch(url,{
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
    body:JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 200){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      console.log("status"+response.status+", msg:"+response.message)
    }

  })
  .catch(error=>{
    console.log(error)
  })  
}

let deleteTeam = (id) =>{
  data={
    teamId:id
  }
  console.log(data)
  let url = "../../Teams/?teamId="+id; 
  fetch(url,{
    method: 'DELETE',
    /*headers: {
      'Content-Type': 'application/json'
    },*/
    //credentials: 'include',
   // body:JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 200){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      console.log("status"+response.status+", msg:"+response.message)
    }

  })
  .catch(error=>{
    console.log(error)
  })  
}

let changeSearch = (id) =>{
  console.log('fuck')
selectedTournament = id;
}

let addTourney = (obj) =>{
  $("#tourneyList").append(
    `<a href="../tourney?id=${obj.tournaments_id}" class="list-group-item list-group-item-action text-center">`+ obj.tournaments_name +'</a>'+
	`<a class="btn btn-danger mb-2" onclick="deleteTourney(${obj.tournaments_id})">Eliminar Torneo</a>`
  )
}


let removeSearch = (element) =>{
  $(element).empty()
}
let insertTeam = () =>{
  data = {
      team_country:$('#team_c')[0].value,
      team_name:$('#name_team')[0].value,
      teams_url:"url",
      team_description:$('#descrip')[0].value,
      tournaments_id:$('#team_t')[0].value

  }
  console.log(data)
  if(data.team_name !=''){
  let url = "../../Teams/" 
  fetch(url,{
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
    body:JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 201){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      //console.log("status"+response.status+", msg:"+response.message)
    }

  })
}else{
  $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("Faltan valores por ingresar, intente de nuevo")
}  
}
let insertMatch = () =>{
  data = {
      group_id:1,
      team1:$('#match_team1')[0].value,
      team2:$('#match_team2')[0].value,
      match_date:$('#match_date')[0].value,
      tournamentId:$('#match_t')[0].value

  }
  if(data.match_date !=''){
  let url = "../../Match/" 
  fetch(url,{
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
    body:JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 201){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      console.log("status"+response.status+", msg:"+response.message)
    }

  })
}else{
  $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("Faltan valores por ingresar, intente de nuevo") 
}  
}
let insertTor = () =>{
  data = {
    country:$('#tor_c')[0].value,
    type:$('#type_tor')[0].value,
    tournament_name:$('#name_tor')[0].value,
      

  }
  if(data.tournament_name !=''){
  let url = "../../Tournaments/" 
  fetch(url,{
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
    body:JSON.stringify(data)
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 201){
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append(`${response.message}`)
      window.location.reload();
    }else{
      $('.toast').toast('show')
      removeSearch('.toast-body')
      $('.toast-body').append("status"+response.status+", msg:"+response.message)
      console.log("status"+response.status+", msg:"+response.message)
    }

  })
}else{
  $('.toast').toast('show')
  removeSearch('.toast-body')
  $('.toast-body').append("Faltan valores por ingresar, intente de nuevo")
}  
}


let searchTeams = () =>{
  let url = ''
  let search = $("#searchTeam")[0].value;

  if(search.trim() == ''){
    url = "../../Teams"
  }else{
    url= "../../Teams/" + search
  }

  fetch(url,{
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
  })
  .then(res => res.json())
  .then(response=>{
    if(response.status == 200){
      removeSearch("#accordionTeam")
      response.data.forEach(team => {
        addTeam(team)
      });
    }

  })
  .catch(error=>{
    console.log(error)
  })
}

let selectedTournament;

let searchMatches = () =>{
  fetch("../../Matchs/"+selectedTournament,{
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
  })
  .then(res => res.json())
  .then(res =>{
    if(res.status === 200){
      removeSearch("#matchesList")
      res.data.forEach((match)=>{
        addMatch(match);
      })
    }
    console.log(res)
  })
}
fetch("../../Matchs/"+1,{
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
  })
  .then(res => res.json())
  .then(res =>{
    if(res.status === 200){
      removeSearch("#matchesList")
      res.data.forEach((match)=>{
        addMatch(match);
      })
    }
    console.log(res)
  })
let annexTourney = (obj) =>{
  $("#torneos").append(
    `<option value="${obj.tournaments_id}" onclick="changeSearch(${obj.tournaments_id})">${obj.tournaments_name}</option>`
  )
  $('#team_t').append(
    `<option value="${obj.tournaments_id}">${obj.tournaments_name}</option>`
  )
  $('#match_t').append(
    `<option onclick="changeSearch(${obj.tournaments_id})" value="${obj.tournaments_id}">${obj.tournaments_name}</option>`
  )
}
let annexCountry = (obj) =>{
  $("#tor_c").append(
    `<option value="${obj.country_id}">${obj.country_name}</option>`
  )
  $('#team_c').append(
    `<option value="${obj.country_id}">${obj.country_name}</option>`
  )
}
let annexTeams = (obj) =>{
  $('#match_team1').append(
    `<option value="${obj.teams_id}">${obj.teams_name}</option>`
  )
  $('#match_team2').append(
    `<option value="${obj.teams_id}">${obj.teams_name}</option>`
  )
}
$("#clearTeams").on("click", ()=>{
  removeSearch("#accordionTeam")
})

$("#clearMatch").on("click", ()=>{
  removeSearch("#matchesList")
})

fetch('../../Tournaments',{
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  },
  credentials: 'include',
})
.then(res => res.json())
.then(res =>{
  console.log('tourney',res)
  if(res.status === 200){
    res.data.forEach(tourney => {
      annexTourney(tourney)
      addTourney(tourney)
    });
  }
})
fetch('../../Country',{
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  },
  credentials: 'include',
})
.then(res => res.json())
.then(res =>{
  console.log('Country',res)
  if(res.status === 200){
    res.data.forEach(country => {
      annexCountry(country)
    });
  }
})
fetch('../../Teams',{
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include',
  })
  .then(res => res.json())
  .then(response=>{
    console.log(response)
    if(response.status == 200){
      //removeSearch("#accordionTeam")
      response.data.forEach(team => {
        addTeam(team)
        annexTeams(team)

      });
    }})


$("#buttonTeam").on("click", ()=>{
  searchTeams()
});

$("#button-addon2").on("click", ()=>{
  selectedTournament = $('#torneos').val()
  searchMatches()
});

    </script>
</body>

</html>